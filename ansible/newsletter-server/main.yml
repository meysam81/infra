- name: Newsletter Server
  hosts: hcloud
  gather_facts: true
  become: true
  vars_files:
    - vars.yml
  tasks:
    - name: Update HAProxy config
      ansible.builtin.copy:
        src: haproxy.cfg
        dest: /etc/haproxy/haproxy.cfg
        owner: haproxy
        group: haproxy
        mode: "0644"
      notify: Reload haproxy
      tags:
        - haproxy
    - name: Copy VMAgent config
      ansible.builtin.copy:
        src: vmagent.yml
        dest: /etc/victoria-metrics/vmagent.yml
        owner: victoria-metrics
        group: victoria-metrics
        mode: "0644"
      notify: Reload vmagent
      tags:
        - vmagent-config
  roles:
    - name: monitoring
      tags: monitoring
  handlers:
    - name: Reload haproxy
      ansible.builtin.systemd:
        name: haproxy
        state: reloaded
        daemon_reload: true
    - name: Reload vmagent
      ansible.builtin.systemd:
        name: vmagent
        state: restarted
        daemon_reload: true

- name: Newsletter Server
  hosts: hcloud
  gather_facts: true
  become: true
  vars_files:
    - vars.yml
  tasks:
    - name: Copy HAProxy suspicious bot lists
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /etc/haproxy/{{ item }}
        owner: haproxy
        group: haproxy
        mode: "0644"
      with_items:
        - blocklist_ips.lst
        - shady_user_agents.lst
      tags:
        - haproxy
    - name: Create bad IP service
      tags:
        - bad-ip
      block:
        - name: Create the systemd files
          ansible.builtin.copy:
            src: "{{ item }}"
            dest: /etc/systemd/system/{{ item }}
            owner: root
            group: root
            mode: "0644"
          with_items:
            - update-bad-ips.service
            - update-bad-ips.timer
          notify: Restart bad IP service
        - name: Ensure /etc/haproxy/bad_reputation_ips.lst exists
          ansible.builtin.file:
            path: /etc/haproxy/bad_reputation_ips.lst
            state: touch
            owner: haproxy
            group: haproxy
            mode: "0644"
        - name: Create the bad-ip shell script
          ansible.builtin.copy:
            src: update-bad-ips.sh
            dest: /usr/local/bin/update-bad-ips
            owner: root
            group: root
            mode: "0755"
        - name: Start the bad IP service
          ansible.builtin.systemd:
            name: update-bad-ips.service
            state: started
            daemon_reload: true
        - name: Enable the bad IP timer
          ansible.builtin.systemd:
            name: update-bad-ips.timer
            enabled: true
            daemon_reload: true
    - name: Update HAProxy config
      ansible.builtin.copy:
        src: haproxy.cfg
        dest: /etc/haproxy/haproxy.cfg
        owner: haproxy
        group: haproxy
        mode: "0644"
      notify: Reload haproxy
      tags:
        - haproxy
    - name: Update HAProxy systemd service file
      ansible.builtin.copy:
        src: haproxy.service
        dest: /etc/systemd/system/haproxy.service
        owner: root
        group: root
        mode: "0644"
      notify: Reload haproxy
      tags:
        - haproxy
    - name: Grant /etc/haproxy/ to the haproxy user
      ansible.builtin.file:
        path: /etc/haproxy/
        owner: haproxy
        group: haproxy
        recurse: true
      tags:
        - haproxy
    - name: Copy VMAgent config
      ansible.builtin.copy:
        src: vmagent.yml
        dest: /etc/victoria-metrics/vmagent.yml
        owner: victoria-metrics
        group: victoria-metrics
        mode: "0644"
      notify: Reload vmagent
      tags:
        - vmagent-config
  roles:
    - name: monitoring
      tags: monitoring
  handlers:
    - name: Reload haproxy
      ansible.builtin.systemd:
        name: haproxy
        state: reloaded
        daemon_reload: true
    - name: Reload vmagent
      ansible.builtin.systemd:
        name: vmagent
        state: restarted
        daemon_reload: true
    - name: Restart bad IP service
      ansible.builtin.systemd:
        name: update-bad-ips.service
        state: restarted
        daemon_reload: true

---
alertmanager:
  enabled: true
  spec:
    externalURL: https://alertmanager.developer-friendly.blog
defaultRules:
  groups:
    kubeScheduler:
      create: false
    kubernetesSystemControllerManager:
      create: false
externalVM:
  write:
    basicAuth:
      password:
        key: GRAFANA_CLOUD_PASSWORD
        name: grafana-cloud
      username:
        key: GRAFANA_CLOUD_USERNAME
        name: grafana-cloud
    url: https://prometheus-prod-24-prod-eu-west-2.grafana.net/api/prom/push
extraObjects:
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: grafana-cloud
    spec:
      data:
        - remoteRef:
            key: /grafana_cloud/remote_write/username
          secretKey: GRAFANA_CLOUD_USERNAME
        - remoteRef:
            key: /grafana_cloud/remote_write/password
          secretKey: GRAFANA_CLOUD_PASSWORD
      refreshInterval: 24h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-parameter-store
      target:
        creationPolicy: Owner
        deletionPolicy: Delete
        immutable: false
  # - apiVersion: gateway.networking.k8s.io/v1
  #   kind: HTTPRoute
  #   metadata:
  #     name: alertmanager
  #   spec:
  #     hostnames:
  #       - alertmanager.developer-friendly.blog
  #     parentRefs:
  #       - group: gateway.networking.k8s.io
  #         kind: Gateway
  #         name: global
  #         namespace: default
  #         sectionName: http
  #     rules:
  #       - backendRefs:
  #           - kind: Service
  #             name: vmalertmanager-victoria-metrics-k8s-stack
  #             port: 9093
  #         filters:
  #           - responseHeaderModifier:
  #               set:
  #                 - name: Strict-Transport-Security
  #                   value: max-age=31536000; includeSubDomains; preload
  #             type: ResponseHeaderModifier
  #           - requestMirror:
  #               backendRef:
  #                 kind: Service
  #                 name: echo-server
  #                 namespace: default
  #                 port: 80
  #             type: RequestMirror
  #         matches:
  #           - path:
  #               type: PathPrefix
  #               value: /
  - apiVersion: external-secrets.io/v1beta1
    kind: ExternalSecret
    metadata:
      name: alertmanager
    spec:
      data:
        - remoteRef:
            key: /slack/developer-friendly/webhooks/alerts
          secretKey: slackWebhook
        - remoteRef:
            key: /discord/developer-friendly/webhooks/info
          secretKey: discordWebhook
      refreshInterval: 24h
      secretStoreRef:
        kind: ClusterSecretStore
        name: aws-parameter-store
      target:
        creationPolicy: Owner
        deletionPolicy: Delete
        immutable: false
  - apiVersion: operator.victoriametrics.com/v1beta1
    kind: VMAlertmanagerConfig
    metadata:
      name: alertmanager
      namespace: monitoring
    spec:
      receivers:
        - name: slack
          slack_configs:
            - api_url:
                key: slackWebhook
                name: alertmanager
                optional: false
              channel: "#alerts"
              send_resolved: true
        - name: discord
          discordConfigs:
            - api_url:
                key: discordWebhook
                name: alertmanager
                optional: false
              send_resolved: false
      route:
        active_time_intervals:
          - workdays
        group_by:
          - namespace
        matchers:
          - severity != none
        receiver: discord
        repeat_interval: 4h
        routes:
          - active_time_intervals:
              - everyday
            matchers:
              - severity =~ error|critical
            receiver: slack
            repeat_interval: 1h
      time_intervals:
        - name: workdays
          time_intervals:
            - weekdays:
                - monday
                - tuesday
                - wednesday
                - thursday
                - friday
        - name: everyday
          time_intervals:
            - weekdays:
                - monday
                - tuesday
                - wednesday
                - thursday
                - friday
                - saturday
                - sunday
grafana:
  enabled: false
  forceDeployDatasource: true
  grafana.ini:
    server:
      root_url: https://grafana.developer-friendly.blog
  persistence:
    enabled: false
  sidecar:
    datasources:
      enabled: false
      label: grafana_datasource
  useStatefulSet: true
grafanaOperatorDashboardsFormat:
  enabled: true
kubeControllerManager:
  enabled: false
kubeScheduler:
  enabled: false
vmagent:
  enabled: true
  spec:
    resources:
      limits:
        cpu: 200m
        memory: 128Mi
      requests:
        cpu: 100m
        memory: 64Mi
vmalert:
  enabled: true
  externalLabels:
    environment: production
  extraArgs:
    external.url: https://alertmanager.developer-friendly.blog
vmsingle:
  enabled: true
  retentionPeriod: 1h
  spec:
    storage: null

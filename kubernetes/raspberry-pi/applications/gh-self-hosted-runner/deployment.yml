---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gh-self-hosted-runner
spec:
  replicas: 1
  template:
    spec:
      containers:
        - args:
            - ./run.sh
          command:
            - sh
            - -c
          envFrom:
            - configMapRef:
                name: gh-self-hosted-runner
          image: ghcr.io/actions/actions-runner
          name: runner
          resources:
            limits:
              cpu: 1000m
              memory: 512Mi
            requests:
              cpu: 10m
              memory: 16Mi
          securityContext:
            readOnlyRootFilesystem: true
            runAsNonRoot: true
          volumeMounts:
            - mountPath: /home/runner
              name: runner
      initContainers:
        - args:
            - |
              set -eux

              if [ "$(ls -A /data)" ]; then
                echo "data directory is not empty"
              else
                sudo apt install -y rsync

                rsync -azuvb /home/runner/ /data
              fi
          command:
            - sh
            - -c
          image: ghcr.io/actions/actions-runner
          name: workdir
          securityContext:
            readOnlyRootFilesystem: true
            runAsNonRoot: true
          volumeMounts:
            - mountPath: /data
              name: runner
        - args:
            - ./config.sh --url $URL --token $TOKEN --unattended || exit 0
          command:
            - sh
            - -c
          envFrom:
            - configMapRef:
                name: gh-self-hosted-runner
            - secretRef:
                name: gh-self-hosted-runner
          image: ghcr.io/actions/actions-runner
          name: configure
          securityContext:
            readOnlyRootFilesystem: true
            runAsNonRoot: true
          volumeMounts:
            - mountPath: /home/runner
              name: runner
      securityContext:
        runAsUser: 1001
        fsGroup: 1001
      volumes:
        - emptyDir: {}
          name: runner
